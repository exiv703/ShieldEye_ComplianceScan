from __future__ import annotations

from dataclasses import dataclass
from enum import Enum
from typing import Dict, Optional
import logging

logger = logging.getLogger("shieldeye.scoring")

class AttackVector(Enum):
    NETWORK = ("N", 0.85, "Network - remotely exploitable")
    ADJACENT = ("A", 0.62, "Adjacent Network - local network required")
    LOCAL = ("L", 0.55, "Local - local access required")
    PHYSICAL = ("P", 0.20, "Physical - physical access required")

class AttackComplexity(Enum):
    LOW = ("L", 0.77, "Low - no special conditions")
    HIGH = ("H", 0.44, "High - special conditions required")

class PrivilegesRequired(Enum):
    NONE = ("N", 0.85, "None - no authentication required")
    LOW = ("L", 0.62, "Low - basic user privileges")
    HIGH = ("H", 0.27, "High - admin privileges required")

class UserInteraction(Enum):
    NONE = ("N", 0.85, "None - no user interaction")
    REQUIRED = ("R", 0.62, "Required - user must take action")

class Scope(Enum):
    UNCHANGED = ("U", "Unchanged - same security authority")
    CHANGED = ("C", "Changed - different security authority")

class Impact(Enum):
    NONE = ("N", 0.0, "None")
    LOW = ("L", 0.22, "Low")
    HIGH = ("H", 0.56, "High")

@dataclass
class VulnerabilityScore:
    
    attack_vector: AttackVector
    attack_complexity: AttackComplexity
    privileges_required: PrivilegesRequired
    user_interaction: UserInteraction
    scope: Scope
    confidentiality_impact: Impact
    integrity_impact: Impact
    availability_impact: Impact
    
    base_score: float = 0.0
    severity: str = "NONE"
    vector_string: str = ""
    
    def __post_init__(self):
        self.calculate_score()
    
    def calculate_score(self) -> None:
        
        isc_base = 1 - (
            (1 - self.confidentiality_impact.value[1]) *
            (1 - self.integrity_impact.value[1]) *
            (1 - self.availability_impact.value[1])
        )
        
        if self.scope == Scope.UNCHANGED:
            impact = 6.42 * isc_base
        else:
            impact = 7.52 * (isc_base - 0.029) - 3.25 * pow(isc_base - 0.02, 15)
        
        pr_value = self.privileges_required.value[1]
        if self.scope == Scope.CHANGED and self.privileges_required != PrivilegesRequired.NONE:
            pr_map = {
                PrivilegesRequired.LOW: 0.68,
                PrivilegesRequired.HIGH: 0.50
            }
            pr_value = pr_map.get(self.privileges_required, pr_value)
        
        exploitability = (
            8.22 *
            self.attack_vector.value[1] *
            self.attack_complexity.value[1] *
            pr_value *
            self.user_interaction.value[1]
        )
        
        if impact <= 0:
            self.base_score = 0.0
        elif self.scope == Scope.UNCHANGED:
            self.base_score = min(impact + exploitability, 10.0)
        else:
            self.base_score = min(1.08 * (impact + exploitability), 10.0)
        
        self.base_score = round(self.base_score, 1)
        
        if self.base_score == 0.0:
            self.severity = "NONE"
        elif self.base_score < 4.0:
            self.severity = "LOW"
        elif self.base_score < 7.0:
            self.severity = "MEDIUM"
        elif self.base_score < 9.0:
            self.severity = "HIGH"
        else:
            self.severity = "CRITICAL"
        
        self.vector_string = (
            f"CVSS:3.1/"
            f"AV:{self.attack_vector.value[0]}/"
            f"AC:{self.attack_complexity.value[0]}/"
            f"PR:{self.privileges_required.value[0]}/"
            f"UI:{self.user_interaction.value[0]}/"
            f"S:{self.scope.value[0]}/"
            f"C:{self.confidentiality_impact.value[0]}/"
            f"I:{self.integrity_impact.value[0]}/"
            f"A:{self.availability_impact.value[0]}"
        )
    
    def to_dict(self) -> Dict:
        return {
            "base_score": self.base_score,
            "severity": self.severity,
            "vector_string": self.vector_string,
            "metrics": {
                "attack_vector": self.attack_vector.value[2],
                "attack_complexity": self.attack_complexity.value[2],
                "privileges_required": self.privileges_required.value[2],
                "user_interaction": self.user_interaction.value[2],
                "scope": self.scope.value[1],
                "confidentiality_impact": self.confidentiality_impact.value[2],
                "integrity_impact": self.integrity_impact.value[2],
                "availability_impact": self.availability_impact.value[2]
            }
        }

class VulnerabilityScorer:
    
    VULNERABILITY_PROFILES = {
        "missing_ssl": VulnerabilityScore(
            AttackVector.NETWORK,
            AttackComplexity.LOW,
            PrivilegesRequired.NONE,
            UserInteraction.NONE,
            Scope.UNCHANGED,
            Impact.HIGH,
            Impact.HIGH,
            Impact.NONE
        ),
        "weak_ssl": VulnerabilityScore(
            AttackVector.NETWORK,
            AttackComplexity.HIGH,
            PrivilegesRequired.NONE,
            UserInteraction.NONE,
            Scope.UNCHANGED,
            Impact.HIGH,
            Impact.HIGH,
            Impact.NONE
        ),
        
        "missing_hsts": VulnerabilityScore(
            AttackVector.NETWORK,
            AttackComplexity.LOW,
            PrivilegesRequired.NONE,
            UserInteraction.REQUIRED,
            Scope.UNCHANGED,
            Impact.LOW,
            Impact.LOW,
            Impact.NONE
        ),
        "missing_csp": VulnerabilityScore(
            AttackVector.NETWORK,
            AttackComplexity.LOW,
            PrivilegesRequired.NONE,
            UserInteraction.REQUIRED,
            Scope.CHANGED,
            Impact.LOW,
            Impact.LOW,
            Impact.NONE
        ),
        "missing_x_frame_options": VulnerabilityScore(
            AttackVector.NETWORK,
            AttackComplexity.LOW,
            PrivilegesRequired.NONE,
            UserInteraction.REQUIRED,
            Scope.UNCHANGED,
            Impact.LOW,
            Impact.LOW,
            Impact.NONE
        ),
        
        "insecure_cookie": VulnerabilityScore(
            AttackVector.ADJACENT,
            AttackComplexity.LOW,
            PrivilegesRequired.NONE,
            UserInteraction.NONE,
            Scope.UNCHANGED,
            Impact.HIGH,
            Impact.LOW,
            Impact.NONE
        ),
        "missing_httponly": VulnerabilityScore(
            AttackVector.NETWORK,
            AttackComplexity.LOW,
            PrivilegesRequired.NONE,
            UserInteraction.REQUIRED,
            Scope.CHANGED,
            Impact.LOW,
            Impact.LOW,
            Impact.NONE
        ),
        
        "unencrypted_form": VulnerabilityScore(
            AttackVector.NETWORK,
            AttackComplexity.LOW,
            PrivilegesRequired.NONE,
            UserInteraction.NONE,
            Scope.UNCHANGED,
            Impact.HIGH,
            Impact.HIGH,
            Impact.NONE
        ),
        "missing_csrf": VulnerabilityScore(
            AttackVector.NETWORK,
            AttackComplexity.LOW,
            PrivilegesRequired.NONE,
            UserInteraction.REQUIRED,
            Scope.UNCHANGED,
            Impact.HIGH,
            Impact.HIGH,
            Impact.NONE
        ),
        
        "missing_privacy_policy": VulnerabilityScore(
            AttackVector.NETWORK,
            AttackComplexity.LOW,
            PrivilegesRequired.NONE,
            UserInteraction.NONE,
            Scope.UNCHANGED,
            Impact.LOW,
            Impact.NONE,
            Impact.NONE
        ),
        "missing_cookie_consent": VulnerabilityScore(
            AttackVector.NETWORK,
            AttackComplexity.LOW,
            PrivilegesRequired.NONE,
            UserInteraction.NONE,
            Scope.UNCHANGED,
            Impact.LOW,
            Impact.NONE,
            Impact.NONE
        ),
    }
    
    @classmethod
    def score_finding(cls, category: str, message: str) -> Optional[VulnerabilityScore]:
        
        message_lower = message.lower()
        
        for key, profile in cls.VULNERABILITY_PROFILES.items():
            if key.replace('_', ' ') in message_lower:
                logger.debug(f"Matched vulnerability profile: {key}")
                return profile
        
        if category == "ssl" or category == "https":
            if "not using https" in message_lower or "no ssl" in message_lower:
                return cls.VULNERABILITY_PROFILES["missing_ssl"]
            else:
                return cls.VULNERABILITY_PROFILES["weak_ssl"]
        
        elif category == "headers":
            if "hsts" in message_lower:
                return cls.VULNERABILITY_PROFILES["missing_hsts"]
            elif "content-security-policy" in message_lower or "csp" in message_lower:
                return cls.VULNERABILITY_PROFILES["missing_csp"]
            elif "x-frame-options" in message_lower:
                return cls.VULNERABILITY_PROFILES["missing_x_frame_options"]
            else:
                return VulnerabilityScore(
                    AttackVector.NETWORK,
                    AttackComplexity.LOW,
                    PrivilegesRequired.NONE,
                    UserInteraction.REQUIRED,
                    Scope.UNCHANGED,
                    Impact.LOW,
                    Impact.LOW,
                    Impact.NONE
                )
        
        elif category == "cookies":
            if "secure" in message_lower and "not set" in message_lower:
                return cls.VULNERABILITY_PROFILES["insecure_cookie"]
            elif "httponly" in message_lower:
                return cls.VULNERABILITY_PROFILES["missing_httponly"]
            else:
                return VulnerabilityScore(
                    AttackVector.ADJACENT,
                    AttackComplexity.LOW,
                    PrivilegesRequired.NONE,
                    UserInteraction.NONE,
                    Scope.UNCHANGED,
                    Impact.LOW,
                    Impact.LOW,
                    Impact.NONE
                )
        
        elif category == "forms":
            if "http" in message_lower and "not https" in message_lower:
                return cls.VULNERABILITY_PROFILES["unencrypted_form"]
            elif "csrf" in message_lower:
                return cls.VULNERABILITY_PROFILES["missing_csrf"]
            else:
                return VulnerabilityScore(
                    AttackVector.NETWORK,
                    AttackComplexity.LOW,
                    PrivilegesRequired.NONE,
                    UserInteraction.REQUIRED,
                    Scope.UNCHANGED,
                    Impact.LOW,
                    Impact.LOW,
                    Impact.NONE
                )
        
        elif category == "privacy":
            return cls.VULNERABILITY_PROFILES["missing_privacy_policy"]
        
        return VulnerabilityScore(
            AttackVector.NETWORK,
            AttackComplexity.LOW,
            PrivilegesRequired.LOW,
            UserInteraction.REQUIRED,
            Scope.UNCHANGED,
            Impact.LOW,
            Impact.LOW,
            Impact.NONE
        )
    
    @classmethod
    def create_custom_score(
        cls,
        attack_vector: str = "N",
        attack_complexity: str = "L",
        privileges_required: str = "N",
        user_interaction: str = "N",
        scope: str = "U",
        confidentiality: str = "L",
        integrity: str = "L",
        availability: str = "N"
    ) -> VulnerabilityScore:
        
        av_map = {"N": AttackVector.NETWORK, "A": AttackVector.ADJACENT, 
                  "L": AttackVector.LOCAL, "P": AttackVector.PHYSICAL}
        ac_map = {"L": AttackComplexity.LOW, "H": AttackComplexity.HIGH}
        pr_map = {"N": PrivilegesRequired.NONE, "L": PrivilegesRequired.LOW, 
                  "H": PrivilegesRequired.HIGH}
        ui_map = {"N": UserInteraction.NONE, "R": UserInteraction.REQUIRED}
        s_map = {"U": Scope.UNCHANGED, "C": Scope.CHANGED}
        i_map = {"N": Impact.NONE, "L": Impact.LOW, "H": Impact.HIGH}
        
        return VulnerabilityScore(
            av_map.get(attack_vector, AttackVector.NETWORK),
            ac_map.get(attack_complexity, AttackComplexity.LOW),
            pr_map.get(privileges_required, PrivilegesRequired.NONE),
            ui_map.get(user_interaction, UserInteraction.NONE),
            s_map.get(scope, Scope.UNCHANGED),
            i_map.get(confidentiality, Impact.LOW),
            i_map.get(integrity, Impact.LOW),
            i_map.get(availability, Impact.NONE)
        )
